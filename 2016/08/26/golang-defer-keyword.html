<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>
      
        On Golang's `defer` Keyword
      
    </title>
    <meta name="description" content="Tejas Manohar is a software engineer that enjoys crafting elegant solutions to real problems." />
    <meta property="og:image" content="https://tejas.io/public/images/segment-green-profile-og.jpg">

    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,300,700' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Bree+Serif' rel='stylesheet' type='text/css'>
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
    <link rel="stylesheet" type="text/css" href="/public/css/main.css">
    <link rel="stylesheet" type="text/css" href="/public/css/prism.css">

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>


<header id="header">
	<a id="logo" href="/">
		<img src="/public/images/segment-green-profile.jpg" />
	</a>

	<h1><a href="/">Tejas Manohar</a></h1>
	<div id="follow-icons">
	<a href="https://twitter.com/tejasmanohar"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="https://github.com/tejasmanohar"><i class="fa fa-github-square fa-2x"></i></a>
	<a href="https://linkedin.com/in/tejasmanohar"><i class="fa fa-linkedin-square fa-2x"></i></a>
</div>

	
  
  <h6><a href="/about" >About</a></h6>

  
  <h6><a href="/" >Writing</a></h6>

  
  <h6><a href="/speaking" >Speaking</a></h6>

  
  <h6><a href="/press" >Press</a></h6>

  
  <h6><a href="/contact" >Contact</a></h6>

  
  <h6><a href="/" ></a></h6>


</header>

<main id="content">
	<h2>On Golang's `defer` Keyword</h2>
<time>Aug 26, 2016</time>

<p>Golang has a <em>defer</em> keyword, which postpones the execution of a function to after the
surrounding function returns. Functions are
<a href="https://en.wikipedia.org/wiki/Stack_(abstract_data_type)">stacked</a> so that the last
deferred function is run first.</p>

<p>Let’s check out an example of this in practice.</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">writeLogs</span><span class="p">(</span><span class="n">c</span><span class="x"> </span><span class="k">chan</span><span class="x"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="k">defer</span><span class="x"> </span><span class="n">stats</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="s">"write_logs_fn"</span><span class="p">,</span><span class="x"> </span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span><span class="x"> </span><span class="c">// order: 4</span><span class="x">

  </span><span class="n">file</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="s">"request.log"</span><span class="p">,</span><span class="x"> </span><span class="n">filename</span><span class="p">)</span><span class="x">
  </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
  </span><span class="p">}</span><span class="x">
  </span><span class="k">defer</span><span class="x"> </span><span class="n">file</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x"> </span><span class="c">// order: 3</span><span class="x">

  </span><span class="n">writer</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">csv</span><span class="o">.</span><span class="n">NewWriter</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="x">
  </span><span class="k">defer</span><span class="x"> </span><span class="n">writer</span><span class="o">.</span><span class="n">Flush</span><span class="p">()</span><span class="x"> </span><span class="c">// order: 2</span><span class="x">

  </span><span class="k">for</span><span class="x"> </span><span class="n">line</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">c</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
      </span><span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">defer</span><span class="x"> </span><span class="n">stats</span><span class="o">.</span><span class="n">Increment</span><span class="p">(</span><span class="s">"wrote_line"</span><span class="p">)</span><span class="x"> </span><span class="c">// order: 1</span><span class="x">
  </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<p>At first glance, you may ask–</p>
<blockquote>
  <p>How is this different from the <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/finally.html"><strong>finally</strong> keyword</a> in other languages?</p>
</blockquote>

<p>From <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/finally.html">Java Docs</a>,</p>
<blockquote>
  <p><strong>finally</strong> is useful for more than just exception handling — it allows the programmer to avoid having cleanup code accidentally bypassed by a return, continue, or break. Putting cleanup code in a finally block is always a good practice, even when no exceptions are anticipated.</p>
</blockquote>

<p>Well, let’s compare <em>defer</em> to the following Java example using <em>finally</em>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">static</span> <span class="kt">void</span> <span class="nf">writeLogs</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">lines</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
  <span class="n">Date</span> <span class="n">start</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>
  <span class="n">FileWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">lineCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

  <span class="k">try</span> <span class="o">{</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileWriter</span><span class="o">(</span><span class="s">"request.log"</span><span class="o">);</span>
    <span class="c1">// non-buffered input</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lines</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="c1">// naive CSV writer</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">lines</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">{</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">writer</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
      <span class="n">lineCount</span><span class="o">++;</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
      <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">stats</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="s">"wrote_line"</span><span class="o">,</span> <span class="n">lineCount</span><span class="o">);</span>
    <span class="n">stats</span><span class="o">.</span><span class="na">duration</span><span class="o">(</span><span class="n">start</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Off the bat, you can identify a handful of “gotchas”:</p>

<ul>
  <li>
    <p><strong>Separation of similar concerns.</strong> <em>finally</em> separates alike concerns. Because you can’t declare that you’d like to close a file when you open it, you can’t effectively plan ahead; instead, you have to remember to fit it into the surrounding context. I can’t count how many programmer errors I’ve seen due to separating alike concerns.</p>
  </li>
  <li>
    <p><strong>Interruptions.</strong> <em>finally</em> requires immediate, exclusive, and interrupting attention, whereas <em>defer</em> allows you to plan ahead without interrupting your usual control flow. In the Go example, we could easily defer incrementing a metric as we read each line, whereas in Java, deferring multiple calls would require more advanced control flow, like a queue, so instead, we have to <em>reorganize</em> our flow by aggregating.</p>
  </li>
  <li>
    <p><strong>Readability.</strong> <em>finally</em> enforces nesting, which hurts overall readability, whereas <em>defer</em> can be dropped in inline. Notice the <em>!= null</em> check, counters, and separate definition from declaration. Holistically, none of these characteristics are meaningful to a reader, but they’re forced to parse it due to the nested structure.</p>
  </li>
</ul>

<p>Alike most technical debt, I’ve found that each of these “gotchas” becomes more apparent as the complexity of your function grows.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Though unconventional, Go’s <em>defer</em> is pure brilliance. It disguises a generally complex control flow with a simple, universal one that both helps readability and keeps things declarative. It’s far superior to traditional teardown via <em>finally</em>, and you should almost always prefer it to rolling out your own control flow.</p>


<hr>

<a href="/">
<h6>
  <i class="fa fa-arrow-left" aria-hidden="true"></i>
  Back to the list of posts
</h6>
</a>

</main>

<!-- <footer id="footer" style="position: absolute; bottom: 0; left: 0; right: 0; text-align: center;"> -->
<footer id="footer">
  <section id="footer-message">&copy;  Tejas Manohar. All rights reserved.</section>
</footer>

<script src="/public/js/prism.js"></script>
<script src="//cdn.jsdelivr.net/cash/1.3.0/cash.min.js"></script>
<script>
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="4.0.0";
  analytics.load("D3cc98obMFxPB9Kf96kAz6HuFnPe15Bf");
  analytics.page();
  }}();
</script>

